<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Agenda Â· Laboral Â· MÃ¡ster Â· InglÃ©s Â· Calistenia Â· Calendario Â· Diario (Google-ready)</title>
<style>
  :root{
    --bg:#0f1320; --panel:#161a2a; --muted:#8ea0b5; --text:#e9eef6;
    --accent:#5cc8ff; --accent-2:#9dff6e; --danger:#ff6b6b; --warn:#ffd166;
    --ok:#3ddc97; --card:#1c2236; --line:#28314a; --shadow:0 8px 24px rgba(0,0,0,.35);
    --radius:14px;
  }
  [data-theme="light"]{
    --bg:#f6f8fb; --panel:#ffffff; --card:#ffffff; --text:#1d2636; --muted:#5b6a7d;
    --line:#e7ecf3; --accent:#0066ff; --accent-2:#16a34a; --danger:#e11d48; --warn:#b45309; --ok:#0ea5e9;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0; font:16px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial; color:var(--text); background:linear-gradient(180deg,var(--bg),#0b0e17 60%)}
  header{position:sticky; top:0; z-index:5; backdrop-filter:saturate(140%) blur(6px); background:linear-gradient(180deg,rgba(0,0,0,.25),transparent); padding:16px clamp(12px,2vw,28px); display:flex; align-items:center; gap:12px; border-bottom:1px solid var(--line)}
  .brand{font-weight:800; letter-spacing:.2px; display:flex; align-items:center; gap:10px}
  .brand .dot{width:12px; height:12px; border-radius:50%; background:var(--accent); box-shadow:0 0 18px var(--accent)}
  .spacer{flex:1}
  .btn, button{border:1px solid var(--line); background:var(--panel); color:var(--text); padding:10px 14px; border-radius:12px; cursor:pointer; transition:.15s; box-shadow:var(--shadow)}
  .btn:hover, button:hover{transform:translateY(-1px); border-color:var(--accent)}
  .tabs{display:flex; gap:10px; flex-wrap:wrap}
  .tab{display:inline-flex; align-items:center; gap:8px; padding:10px 14px; border-radius:12px; border:1px solid var(--line); background:var(--card); cursor:pointer; text-decoration:none; color:inherit}
  .tab.active{outline:2px solid var(--accent); background:linear-gradient(180deg,var(--card),#141a2b)}
  main{padding:24px clamp(12px,2vw,28px) 36px; max-width:1200px; margin:auto}
  .grid{display:grid; gap:18px}
  @media (min-width:960px){ .grid-2{grid-template-columns:1fr 1fr} .grid-3{grid-template-columns:1fr 1fr 1fr} }
  .card{background:var(--card); border:1px solid var(--line); border-radius:14px; padding:18px; box-shadow:var(--shadow)}
  h1{font-size:clamp(20px,3vw,26px); margin:0 0 8px}
  h2{font-size:18px; margin:0 0 12px}
  .muted{color:var(--muted)}
  input[type="text"], input[type="date"], input[type="time"], input[type="month"], input[type="number"], select, textarea{width:100%; padding:10px 12px; border-radius:10px; border:1px solid var(--line); background:var(--panel); color:var(--text); outline:none}
  .row{display:flex; gap:10px; flex-wrap:wrap}
  .pill{display:inline-flex; align-items:center; gap:6px; padding:6px 10px; border-radius:999px; border:1px solid var(--line); background:var(--panel); font-size:12px}
  .list{display:flex; flex-direction:column; gap:10px}
  .item{display:grid; grid-template-columns:auto 1fr auto; align-items:center; gap:10px; padding:10px; border:1px dashed var(--line); border-radius:12px; background:linear-gradient(180deg,rgba(255,255,255,.02),transparent)}
  .item.done{opacity:.65; text-decoration:line-through}
  .item .due{font-size:12px; color:var(--muted)}
  .mini{font-size:12px}
  .kbd{font-family:ui-monospace, Menlo, Monaco, Consolas, "Liberation Mono"; font-size:12px; padding:2px 6px; border:1px solid var(--line); border-radius:6px; background:var(--panel)}
  .footer{margin-top:26px; text-align:center; color:var(--muted); font-size:12px}
  .counter{font-variant-numeric:tabular-nums}
  .tag{padding:2px 8px; border-radius:999px; border:1px solid var(--line)}
  .cta{background:linear-gradient(90deg,var(--accent),#8b5cf6); color:white; border:none}
  .cta:hover{filter:saturate(110%)}
  .link{color:var(--accent); text-decoration:none}
  .table{width:100%; border-collapse:collapse; font-size:14px}
  .table th,.table td{border-bottom:1px solid var(--line); padding:8px 6px; text-align:left}
  details{border:1px solid var(--line); border-radius:12px; padding:10px 12px; background:var(--panel)}
  details summary{cursor:pointer; font-weight:600; margin:-10px -12px 10px; padding:10px 12px}
  .cal-grid{display:grid; grid-template-columns:repeat(7,1fr); gap:8px}
  .cal-cell{border:1px solid var(--line); border-radius:10px; padding:8px; min-height:90px; background:var(--panel); position:relative}
  .cal-day{font-size:12px; opacity:.8}
  .cal-ev{margin-top:6px; font-size:12px; padding:4px 6px; border-radius:8px; border:1px solid var(--line); background:rgba(255,255,255,.04)}
  .cal-nav{display:flex; align-items:center; gap:8px}
  .entry{border:1px solid var(--line); border-radius:12px; padding:12px; background:var(--panel)}
  .entry h3{margin:0 0 6px}
  .save-badge{font-size:12px; color:var(--muted)}
</style>
</head>
<body data-theme="dark">
<header>
  <div class="brand"><span class="dot"></span> Agenda Â· Offline</div>
  <nav class="tabs">
    <a class="tab" href="#laboral">ğŸ’¼ Laboral</a>
    <a class="tab" href="#master">ğŸ“ MÃ¡ster</a>
    <a class="tab" href="#ingles">ğŸ—£ï¸ InglÃ©s</a>
    <a class="tab" href="#calistenia">ğŸ‹ï¸ Calistenia</a>
    <a class="tab" href="#calendario">ğŸ“… Calendario</a>
    <a class="tab" href="#diario">ğŸ““ Diario</a>
  </nav>
  <div class="spacer"></div>
  <button id="themeBtn" title="Modo claro/oscuro">ğŸŒ“</button>
  <button id="exportBtn" class="btn" title="Exportar datos">â¬‡ï¸ Exportar</button>
  <label class="btn" title="Importar datos">
    â¬†ï¸ Importar <input id="importFile" type="file" accept="application/json" hidden>
  </label>
</header>

<main id="view"></main>

<footer class="footer">
  Totalmente offline â€¢ Guarda automÃ¡tico â€¢
  Atajos: <span class="kbd">/</span> buscar Â· <span class="kbd">n</span> nueva tarea (vista actual)
</footer>

<!-- Google Option C scripts (only needed if usarÃ¡s Calendar API) -->
<script src="https://accounts.google.com/gsi/client" async defer></script>
<script src="https://apis.google.com/js/api.js"></script>

<script>
/* ========= Estado y Utilidades ========= */
const KEY = "agendaEdu_v4";
let data = JSON.parse(localStorage.getItem(KEY) || "{}");
const $ = (sel, root=document) => root.querySelector(sel);
const $$ = (sel, root=document) => [...root.querySelectorAll(sel)];
const save = () => localStorage.setItem(KEY, JSON.stringify(data));
const fmtDate = d => new Date(d).toLocaleDateString(undefined,{year:'numeric',month:'short',day:'2-digit'});
const daysLeft = d => {
  if(!d) return "";
  const one=24*3600*1000, diff=(new Date(d).setHours(0,0,0,0)-new Date().setHours(0,0,0,0))/one;
  if (isNaN(diff)) return "";
  return diff===0? "hoy" : (diff>0? `en ${diff} dÃ­a${diff===1?"":"s"}` : `hace ${Math.abs(diff)} dÃ­a${Math.abs(diff)===1?"":"s"}`);
}
const uid = () => Math.random().toString(36).slice(2,9);

// Google Calendar (Option C) placeholders
const GOOGLE_CLIENT_ID = "801729850820-gsvklnctk9ga4054hmal67ngmoahqej9.apps.googleusercontent.com";
const GOOGLE_API_KEY   = "AIzaSyDwf0PKeUgtudWJ9YWAJZQSSJENbISkoAg"; // opcional si solo usas OAuth + discovery
const GOOGLE_DISCOVERY = "https://www.googleapis.com/discovery/v1/apis/calendar/v3/rest";
const GOOGLE_SCOPES    = "https://www.googleapis.com/auth/calendar.events https://www.googleapis.com/auth/calendar.readonly";
let googleAuthed = false;

/* ========= Plantillas ========= */
function layoutLaboral(){
  const list = (data.laboral?.tasks)||[];
  const htmlItems = list.map(it => taskItem(it,'laboral')).join('');

  // Surgery assistant data
  const inv = data.surgery?.stock || [];
  const pend = data.surgery?.pending || [];
  const rowsInv = inv.map(p => `
    <tr data-id="${p.id}">
      <td>${p.volume} cc</td>
      <td>${p.proj || '-'}</td>
      <td>${p.shape}</td>
      <td><input type="checkbox" data-field="steril" ${p.sterilized?'checked':''}></td>
      <td><input type="checkbox" data-field="used"></td>
      <td><button data-del>ğŸ—‘</button></td>
    </tr>`).join('') || `<tr><td colspan="6" class="muted">Sin stock</td></tr>`;
  const rowsPend = pend.map(p => `
    <tr data-id="${p.id}">
      <td>${p.volume} cc</td>
      <td>${p.proj || '-'}</td>
      <td>${p.shape}</td>
      <td><button data-steril>âœ… Marcar esterilizada</button></td>
      <td><button data-del>ğŸ—‘</button></td>
    </tr>`).join('') || `<tr><td colspan="5" class="muted">Sin pendientes</td></tr>`;

  // Extra income
  const inc = data.surgery?.income || [];
  const rowsInc = inc.slice().sort((a,b)=>a.month.localeCompare(b.month)).map(x=>`
    <tr data-id="${x.id}"><td>${x.month}</td><td style="text-align:right">${Number(x.amount||0).toFixed(2)} â‚¬</td><td><button data-del>ğŸ—‘</button></td></tr>
  `).join('') || `<tr><td colspan="3" class="muted">Sin registros</td></tr>`;
  const totalInc = inc.reduce((s,x)=> s + (Number(x.amount)||0), 0);

  return `
  <section class="grid grid-2" data-route="laboral">
    <div class="card">
      <h1>ğŸ’¼ Laboral</h1>
      <p class="muted">Tareas por prioridad, plazos y estado. Guarda automÃ¡tico.</p>
      <form class="row" id="formLaboral">
        <input name="title" type="text" placeholder="Nueva tarea (p. ej. cierre de informeâ€¦)" required>
        <input name="due" type="date" title="Fecha lÃ­mite">
        <select name="prio" title="Prioridad">
          <option value="1">Prioridad Alta</option>
          <option value="2">Media</option>
          <option value="3" selected>Baja</option>
        </select>
        <button class="cta">AÃ±adir</button>
      </form>
      <div class="list" id="listLaboral">${htmlItems || `<div class="muted">AÃºn no hay tareas.</div>`}</div>
    </div>

    <div class="grid">
      <div class="card">
        <h2>ğŸ‘¨â€âš•ï¸ Ayudante de CirugÃ­a (Dr. Junco)</h2>
        <details open>
          <summary><strong>Inventario de prÃ³tesis de prueba</strong></summary>
          <form class="row" id="formProt">
            <input name="volume" type="number" min="0" step="1" placeholder="Volumen (cc)" required>
            <input name="proj" type="text" placeholder="ProyecciÃ³n (ej. 805, 810, 812 â€¦)">
            <select name="shape">
              <option value="redonda">Redonda</option>
              <option value="anatÃ³mica">AnatÃ³mica</option>
            </select>
            <label class="pill"><input name="sterilized" type="checkbox" checked> Esterilizada</label>
            <button class="cta">AÃ±adir a stock</button>
          </form>
          <div style="overflow:auto;margin-top:10px">
            <table class="table" id="tblStock">
              <thead><tr><th>Volumen</th><th>ProyecciÃ³n</th><th>Forma</th><th>Esterilizada</th><th>Usada</th><th></th></tr></thead>
              <tbody>${rowsInv}</tbody>
            </table>
          </div>
          <h3 style="margin-top:14px">Pendiente de esterilizar</h3>
          <div style="overflow:auto">
            <table class="table" id="tblPend">
              <thead><tr><th>Volumen</th><th>ProyecciÃ³n</th><th>Forma</th><th>AcciÃ³n</th><th></th></tr></thead>
              <tbody>${rowsPend}</tbody>
            </table>
          </div>
        </details>

        <details>
          <summary><strong>Ingresos extra</strong></summary>
          <form class="row" id="formIncome">
            <input name="month" type="month" required>
            <input name="amount" type="number" step="0.01" min="0" placeholder="Importe (â‚¬)" required>
            <button class="cta">AÃ±adir</button>
          </form>
          <div style="overflow:auto;margin-top:8px">
            <table class="table" id="tblIncome">
              <thead><tr><th>Mes</th><th style="text-align:right">Importe</th><th></th></tr></thead>
              <tbody>${rowsInc}</tbody>
              <tfoot><tr><th>Total</th><th style="text-align:right">${totalInc.toFixed(2)} â‚¬</th><th></th></tr></tfoot>
            </table>
          </div>
        </details>
      </div>
    </div>
  </section>`;
}

function layoutMaster(){
  const list = (data.master?.deliveries)||[];
  const rows = list.map(d => `
    <tr data-id="${d.id}">
      <td>${d.course||'-'}</td>
      <td><strong>${d.title}</strong></td>
      <td>${d.due?fmtDate(d.due):'-'}</td>
      <td class="counter">${daysLeft(d.due)}</td>
      <td>
        <select data-field="status">
          <option ${d.status==='pendiente'?'selected':''}>pendiente</option>
          <option ${d.status==='en curso'?'selected':''}>en curso</option>
          <option ${d.status==='entregado'?'selected':''}>entregado</option>
        </select>
      </td>
      <td><button data-action="del">ğŸ—‘</button></td>
    </tr>`).join('');
  return `
  <section class="grid grid-2" data-route="master">
    <div class="card">
      <h1>ğŸ“ MÃ¡ster</h1>
      <p class="muted">Entregas con fecha y estado + cuenta atrÃ¡s.</p>
      <form class="row" id="formMaster">
        <input name="course" type="text" placeholder="Asignatura (ej. 05MDGE)">
        <input name="title" type="text" placeholder="Entrega / TÃ­tulo" required>
        <input name="due" type="date" required>
        <button class="cta">AÃ±adir</button>
      </form>
      <div class="row" style="overflow:auto">
        <table class="table" id="tblMaster">
          <thead><tr><th>Asignatura</th><th>Entrega</th><th>Fecha</th><th>Cuenta atrÃ¡s</th><th>Estado</th><th></th></tr></thead>
          <tbody>${rows || ''}</tbody>
        </table>
      </div>
    </div>
    <div class="grid">
      <div class="card">
        <h2>ğŸ“š BibliografÃ­a / enlaces</h2>
        <form id="formRefs" class="row">
          <input name="desc" type="text" placeholder="Referencia / apunte">
          <input name="url" type="text" placeholder="https://â€¦ (opcional)">
          <button>Guardar</button>
          <span id="saveRefs" class="save-badge"></span>
        </form>
        <ul id="refsList" class="list mini"></ul>
      </div>

      <div class="card">
        <h2>ğŸ“ Notas</h2>
        <textarea id="masterNotes" rows="10" placeholder="Ideas, guiones de vÃ­deo, checklist de citasâ€¦"></textarea>
        <div class="save-badge" id="saveMasterNotes"></div>
      </div>
    </div>
  </section>`;
}

function layoutIngles(){
  const list = (data.ingles?.cards)||[];
  const dueToday = list.filter(c => !c.next || new Date(c.next) <= new Date()).length;
  const rows = list.map(c => `
    <tr data-id="${c.id}">
      <td><strong>${c.front}</strong></td>
      <td>${c.back||''}</td>
      <td>${c.level||1}</td>
      <td>${c.next?fmtDate(c.next):'â€”'}</td>
      <td>
        <button data-action="pass">âœ… FÃ¡cil</button>
        <button data-action="hard">âš ï¸ DifÃ­cil</button>
        <button data-action="del">ğŸ—‘</button>
      </td>
    </tr>`).join('');
  return `
  <section class="grid grid-2" data-route="ingles">
    <div class="card">
      <h1>ğŸ—£ï¸ InglÃ©s</h1>
      <p class="muted">Mini SRS para vocabulario/chunks. <span class="pill">Pendiente hoy: ${dueToday}</span></p>
      <form class="row" id="formCards">
        <input name="front" type="text" placeholder="Chunk / frase (EN)" required>
        <input name="back" type="text" placeholder="TraducciÃ³n / pista (ES)">
        <button class="cta">AÃ±adir</button>
      </form>
      <div style="overflow:auto">
        <table class="table" id="tblCards">
          <thead><tr><th>Chunk</th><th>Pista</th><th>Nivel</th><th>PrÃ³x. repaso</th><th></th></tr></thead>
          <tbody>${rows || ''}</tbody>
        </table>
      </div>
    </div>
    <div class="grid">
      <div class="card">
        <h2>ğŸ¯ Plan semanal</h2>
        <ul class="mini">
          <li>Luâ€“Vie: 25â€“40â€™ conversaciÃ³n/lectura + 10â€™ revisiÃ³n SRS.</li>
          <li>SÃ¡b: resumen semanal en 10 frases.</li>
          <li>Dom: descanso / repaso ligero.</li>
        </ul>
        <textarea id="inglesNotes" rows="8" placeholder="Roles/roleplays, objetivos de pronunciaciÃ³n, enlacesâ€¦"></textarea>
        <div class="save-badge" id="saveInglesNotes"></div>
      </div>
      <div class="card">
        <h2>ğŸ” BÃºsqueda rÃ¡pida</h2>
        <input id="searchBox" type="text" placeholder="Escribe y pulsa Enter para resaltarâ€¦" />
      </div>
    </div>
  </section>`;
}

function layoutCalistenia(){
  const week = data.cali?.week || {lunes:false,martes:false,miercoles:false,jueves:false,viernes:false,sabado:false,domingo:false};
  const prs = data.cali?.prs || { muscleup:0, hspu:0, frontlever:'', planche:'', hs:'', last:'' };
  const micro = data.cali?.micro || [];
  const rows = micro.map((d,i)=>`
    <tr>
      <td>${d.dia}</td>
      <td contenteditable="true" data-idx="${i}">${d.sesion}</td>
    </tr>`).join('');
  return `
  <section class="grid grid-2" data-route="calistenia">
    <div class="card">
      <h1>ğŸ‹ï¸ Calistenia</h1>
      <p class="muted">Checklist semanal + PRs + Generador de microciclos.</p>
      <div class="row mini">
        ${Object.keys(week).map(d=>`
          <label class="pill">
            <input type="checkbox" data-dow="${d}" ${week[d]?'checked':''}> ${d[0].toUpperCase()+d.slice(1)}
          </label>`).join('')}
      </div>

      <details style="margin-top:12px">
        <summary>âš¡ Generador de Microciclo</summary>
        <form id="formMicro" class="row" style="margin-top:10px">
          <select name="objetivo">
            <option value="fuerza">Fuerza</option>
            <option value="skills">Skills</option>
            <option value="hipertrofia">Hipertrofia</option>
            <option value="mixto">Mixto</option>
          </select>
          <select name="dias">
            <option value="3">3 dÃ­as</option>
            <option value="4">4 dÃ­as</option>
            <option value="5">5 dÃ­as</option>
            <option value="6">6 dÃ­as</option>
          </select>
          <select name="nivel">
            <option value="basico">BÃ¡sico</option>
            <option value="intermedio" selected>Intermedio</option>
            <option value="avanzado">Avanzado</option>
          </select>
          <button class="cta">Generar</button>
        </form>
        <div style="overflow:auto; margin-top:10px">
          <table class="table" id="tblMicro">
            <thead><tr><th>DÃ­a</th><th>SesiÃ³n (editable)</th></tr></thead>
            <tbody>${rows}</tbody>
          </table>
        </div>
        <button id="saveMicro" style="margin-top:8px">ğŸ’¾ Guardar microciclo</button>
      </details>
    </div>

    <div class="grid">
      <div class="card">
        <h2>ğŸ† PR / MÃ©tricas</h2>
        <div class="row">
          <label class="pill">MU reps <input type="number" min="0" id="pr_mu" value="${prs.muscleup||0}" style="width:80px;margin-left:6px"></label>
          <label class="pill">HSPU reps <input type="number" min="0" id="pr_hspu" value="${prs.hspu||0}" style="width:80px;margin-left:6px"></label>
          <label class="pill">Front Lever (tiempo) <input id="pr_fl" type="text" value="${prs.frontlever||''}" style="width:110px;margin-left:6px" placeholder="e.g. 8s"></label>
          <label class="pill">Planche (tiempo) <input id="pr_pl" type="text" value="${prs.planche||''}" style="width:110px;margin-left:6px" placeholder="e.g. 5s"></label>
          <label class="pill">Handstand (tiempo) <input id="pr_hs" type="text" value="${prs.hs||''}" style="width:110px;margin-left:6px" placeholder="e.g. 30s"></label>
        </div>
        <div class="row">
          <button id="savePRs">Guardar PR</button>
          <span class="muted mini" id="prSaved">${prs.last?`Ãšltimo guardado: ${fmtDate(prs.last)}`:''}</span>
        </div>
      </div>

      <div class="card">
        <h2>ğŸ§° Notas de entrenamiento</h2>
        <textarea id="caliNotes" rows="10" placeholder="Microciclos, progresiones (MU, FL, Planche, HS), cargas RPEâ€¦"></textarea>
        <div class="save-badge" id="saveCaliNotes"></div>
      </div>
    </div>
  </section>`;
}

function layoutCalendario(){
  const today = new Date();
  const cur = data.calendar?.cursor ? new Date(data.calendar.cursor) : new Date(today.getFullYear(), today.getMonth(), 1);
  const y = cur.getFullYear(), m = cur.getMonth();
  const firstDay = new Date(y, m, 1);
  const start = new Date(firstDay);
  start.setDate(1 - ((firstDay.getDay()+6)%7)); // Monday
  const monthName = cur.toLocaleDateString(undefined,{month:'long', year:'numeric'});
  const dayNames = ['Lun','Mar','MiÃ©','Jue','Vie','SÃ¡b','Dom'];
  return `
  <section class="grid" data-route="calendario">
    <div class="card">
      <div class="cal-nav">
        <button id="prevMonth">â—€ï¸</button>
        <h1 style="margin:0 8px">${monthName}</h1>
        <button id="nextMonth">â–¶ï¸</button>
        <div class="spacer"></div>
        <button id="todayBtn">Hoy</button>
      </div>
      <div class="row mini" style="margin:10px 0">
        <strong>Google Calendar:</strong>
        <button id="gInit">Inicializar API</button>
        <button id="gSignIn">Iniciar sesiÃ³n</button>
        <button id="gSignOut">Cerrar sesiÃ³n</button>
        <select id="gCals" style="min-width:220px"></select>
        <span id="gStatus" class="muted"></span>
      </div>
      <div class="row mini">
        <form id="gCreate" class="row">
          <input name="date" type="date" required>
          <input name="time" type="time" placeholder="Hora">
          <input name="title" type="text" placeholder="TÃ­tulo" required>
          <button class="cta">Crear en Google</button>
        </form>
      </div>
      <div style="margin:8px 0" class="muted mini">* Para que funcione: sube este archivo a HTTPS, crea un Client ID y API Key, y rellena las constantes en el cÃ³digo.</div>
      <div class="cal-grid" style="margin-top:12px">
        ${dayNames.map(d=>`<div class="muted" style="text-align:center;font-weight:600">${d}</div>`).join('')}
        ${[...Array(42)].map((_,i)=>{
          const date = new Date(start); date.setDate(start.getDate()+i);
          const inMonth = date.getMonth()===m;
          const iso = date.toISOString().slice(0,10);
          return `<div class="cal-cell" data-iso="${iso}" style="opacity:${inMonth?1:.45}"><div class="cal-day">${date.getDate()}</div><div class="g-events" data-day="${iso}" style="margin-top:6px"></div></div>`
        }).join('')}
      </div>
    </div>

    <div class="card">
      <h2>ğŸ—‚ Eventos del mes (Google)</h2>
      <div id="gEventList" class="list mini"></div>
    </div>
  </section>`;
}

function layoutDiario(){
  const entries = data.diario?.entries || []; // {id, date, title, text}
  const items = entries.slice().reverse().map(e=>`
    <div class="entry" data-id="${e.id}">
      <h3>${e.title || '(Sin tÃ­tulo)'} <span class="muted" style="font-weight:400">Â· ${fmtDate(e.date)}</span></h3>
      <p style="white-space:pre-wrap">${(e.text||'')}</p>
      <div class="row mini">
        <button data-edit="${e.id}">âœï¸ Editar</button>
        <button data-del="${e.id}">ğŸ—‘ Eliminar</button>
      </div>
    </div>
  `).join('') || '<div class="muted">AÃºn no hay entradas.</div>';
  return `
  <section class="grid grid-2" data-route="diario">
    <div class="card">
      <h1>ğŸ““ Diario personal</h1>
      <form id="formEntry" class="row">
        <input name="date" type="date" value="${new Date().toISOString().slice(0,10)}" required>
        <input name="title" type="text" placeholder="TÃ­tulo (opcional)">
        <textarea name="text" rows="6" placeholder="Escribe tu entrada..."></textarea>
        <button class="cta">Guardar entrada</button>
      </form>
    </div>
    <div class="card">
      <h2>Entradas</h2>
      <div class="row">
        <input id="searchDiary" type="text" placeholder="Buscar en el diarioâ€¦">
      </div>
      <div id="diaryList" style="margin-top:12px">${items}</div>
    </div>
  </section>`;
}

function taskItem(it, key){
  return `<div class="item ${it.done?'done':''}" data-id="${it.id}">
    <input type="checkbox" ${it.done?'checked':''} data-action="toggle">
    <div>
      <div><strong>${it.title}</strong></div>
      <div class="due">${it.due?`vence ${fmtDate(it.due)} Â· ${daysLeft(it.due)}`:''}</div>
    </div>
    <div class="row">
      <button data-action="edit">âœï¸</button>
      <button data-action="del">ğŸ—‘</button>
    </div>
  </div>`;
}

/* ========= Router ========= */
const routes = {
  laboral:layoutLaboral,
  master:layoutMaster,
  ingles:layoutIngles,
  calistenia:layoutCalistenia,
  calendario:layoutCalendario,
  diario:layoutDiario
};
function render(){
  const hash = (location.hash||"#laboral").replace("#","");
  const tpl = routes[hash] ? routes[hash]() : layoutLaboral();
  $("#view").innerHTML = tpl;
  $$(".tab").forEach(a => a.classList.toggle("active", a.getAttribute("href")==="#"+hash));
  if(hash==="laboral") hookLaboral();
  if(hash==="master") hookMaster();
  if(hash==="ingles") hookIngles();
  if(hash==="calistenia") hookCali();
  if(hash==="calendario") hookCalendario();
  if(hash==="diario") hookDiario();
}
window.addEventListener("hashchange", render);

/* ========= Helpers ========= */
function showSaved(el){ if(!el) return; el.textContent = "Guardado âœ”ï¸"; setTimeout(()=>{ el.textContent=""; }, 1200); }

/* ========= Hooks ========= */
function hookLaboral(){
  data.laboral ||= {tasks:[], links:[]}; save();

  $("#formLaboral").addEventListener("submit", e=>{
    e.preventDefault();
    const f = new FormData(e.target);
    const it = {id:uid(), title:f.get("title").trim(), due:f.get("due"), prio:Number(f.get("prio")), done:false};
    data.laboral.tasks.unshift(it); save(); render();
  });

  $("#listLaboral").addEventListener("click", e=>{
    const box = e.target.closest("item") || e.target.closest(".item"); if(!box) return;
    const id = box.dataset.id;
    const t = data.laboral.tasks.find(x=>x.id===id);
    if(e.target.dataset.action==="toggle"){ t.done = !t.done; save(); box.classList.toggle("done", t.done); return; }
    if(e.target.dataset.action==="del"){ data.laboral.tasks = data.laboral.tasks.filter(x=>x.id!==id); save(); box.remove(); return; }
    if(e.target.dataset.action==="edit"){
      const title = prompt("Editar tÃ­tulo:", t.title); if(title!==null){ t.title = title.trim(); save(); render(); }
    }
  });

  // Surgery assistant
  data.surgery ||= {stock:[], pending:[], income:[]}; save();
  $("#formProt").addEventListener("submit", e=>{
    e.preventDefault();
    const f=new FormData(e.target);
    const p = {
      id:uid(),
      volume:Number(f.get("volume")),
      proj:f.get("proj")?.trim(),
      shape:f.get("shape"),
      sterilized: !!f.get("sterilized")
    };
    data.surgery.stock.push(p); save(); render();
  });

  $("#tblStock").addEventListener("click", e=>{
    const tr = e.target.closest("tr"); if(!tr) return;
    const id = tr.dataset.id;
    if(e.target.hasAttribute("data-del")){
      data.surgery.stock = data.surgery.stock.filter(p=>p.id!==id); save(); tr.remove(); return;
    }
  });
  $("#tblStock").addEventListener("change", e=>{
    const tr = e.target.closest("tr"); if(!tr) return;
    const id = tr.dataset.id;
    const p = data.surgery.stock.find(x=>x.id===id); if(!p) return;
    if(e.target.dataset.field==="steril"){ p.sterilized = e.target.checked; save(); return; }
    if(e.target.dataset.field==="used" && e.target.checked){
      // move to pending
      data.surgery.stock = data.surgery.stock.filter(x=>x.id!==id);
      data.surgery.pending.push({...p, sterilized:false});
      save(); render();
    }
  });

  $("#tblPend").addEventListener("click", e=>{
    const tr = e.target.closest("tr"); if(!tr) return;
    const id = tr.dataset.id;
    if(e.target.hasAttribute("data-steril")){
      const p = data.surgery.pending.find(x=>x.id===id);
      data.surgery.pending = data.surgery.pending.filter(x=>x.id!==id);
      data.surgery.stock.push({...p, sterilized:true});
      save(); render();
      return;
    }
    if(e.target.hasAttribute("data-del")){
      data.surgery.pending = data.surgery.pending.filter(p=>p.id!==id); save(); tr.remove(); return;
    }
  });

  // Income
  $("#formIncome").addEventListener("submit", e=>{
    e.preventDefault();
    const f=new FormData(e.target);
    const row = {id:uid(), month:f.get("month"), amount:Number(f.get("amount"))};
    data.surgery.income.push(row); save(); render();
  });
  $("#tblIncome").addEventListener("click", e=>{
    const tr=e.target.closest("tr"); if(!tr) return;
    const id=tr.dataset.id;
    if(e.target.hasAttribute("data-del")){
      data.surgery.income = data.surgery.income.filter(x=>x.id!==id); save(); tr.remove();
    }
  });
}

function hookMaster(){
  data.master ||= {deliveries:[], refs:[], notes:""}; save();

  $("#formMaster").addEventListener("submit", e=>{
    e.preventDefault(); const f=new FormData(e.target);
    data.master.deliveries.push({id:uid(), course:f.get("course").trim(), title:f.get("title").trim(), due:f.get("due"), status:"pendiente"});
    save(); render();
  });

  $("#tblMaster").addEventListener("click", e=>{
    const tr = e.target.closest("tr"); if(!tr) return; const id=tr.dataset.id;
    if(e.target.dataset.action==="del"){ data.master.deliveries = data.master.deliveries.filter(d=>d.id!==id); save(); tr.remove(); }
  });
  $("#tblMaster").addEventListener("change", e=>{
    const tr = e.target.closest("tr"); if(!tr) return; const id=tr.dataset.id;
    const d = data.master.deliveries.find(x=>x.id===id); if(!d) return;
    if(e.target.dataset.field==="status"){ d.status=e.target.value; save(); }
  });

  const ul=$("#refsList");
  const draw=()=> ul.innerHTML=(data.master.refs||[]).map(r=>`<li>â€¢ ${r.url?`<a class="link" href="${r.url}">${r.desc||r.url}</a>`:r.desc} <button data-id="${r.id}">ğŸ—‘</button></li>`).join('') || '<div class="muted mini">Sin referencias aÃºn.</div>';
  $("#formRefs").addEventListener("submit", e=>{
    e.preventDefault(); const f=new FormData(e.target);
    data.master.refs ||= []; data.master.refs.push({id:uid(), desc:f.get("desc"), url:f.get("url")}); save(); e.target.reset(); draw(); showSaved($("#saveRefs"));
  });
  ul.addEventListener("click", e=>{ if(e.target.tagName==="BUTTON"){ data.master.refs=data.master.refs.filter(r=>r.id!==e.target.dataset.id); save(); draw(); }});
  draw();

  $("#masterNotes").value=data.master.notes||"";
  $("#masterNotes").addEventListener("input", e=>{ data.master.notes=e.target.value; save(); showSaved($("#saveMasterNotes")); });
}

function hookIngles(){
  data.ingles ||= {cards:[], notes:""}; save();

  $("#formCards").addEventListener("submit", e=>{
    e.preventDefault(); const f=new FormData(e.target);
    data.ingles.cards.push({id:uid(), front:f.get("front").trim(), back:f.get("back").trim(), level:1, next:null});
    save(); render();
  });

  const schedule = (c, success) => {
    const steps=[0,1,2,4,7,15];
    c.level = Math.max(1, Math.min(6, success ? c.level+1 : Math.max(1, c.level-1)));
    const days = steps[c.level-1] || 15;
    const next = new Date(); next.setDate(next.getDate()+days);
    c.next = next.toISOString().slice(0,10);
  };
  $("#tblCards").addEventListener("click", e=>{
    const tr=e.target.closest("tr"); if(!tr) return; const id=tr.dataset.id;
    const c=data.ingles.cards.find(x=>x.id===id);
    if(e.target.dataset.action==="del"){ data.ingles.cards=data.ingles.cards.filter(x=>x.id!==id); save(); tr.remove(); return; }
    if(e.target.dataset.action==="pass"){ schedule(c,true); save(); render(); }
    if(e.target.dataset.action==="hard"){ schedule(c,false); save(); render(); }
  });

  $("#inglesNotes").value=data.ingles.notes||"";
  $("#inglesNotes").addEventListener("input", e=>{ data.ingles.notes=e.target.value; save(); showSaved($("#saveInglesNotes")); });

  const sb=$("#searchBox");
  sb.addEventListener("keydown", e=>{
    if(e.key==="Enter"){ e.preventDefault(); const q=sb.value.trim(); if(!q) return;
      const rx=new RegExp(q,'gi');
      $$("#tblCards tbody tr").forEach(tr=>{
        tr.style.outline = rx.test(tr.textContent)? `2px solid var(--accent)` : "none";
      });
    }
  });
}

function hookCali(){
  data.cali ||= {week:{}, prs:{}, notes:"", micro:[]}; save();
  $("[data-route='calistenia']")?.querySelectorAll("input[type='checkbox'][data-dow]")?.forEach(ch=>{
    ch.addEventListener("change", e=>{
      const k=e.target.dataset.dow; data.cali.week ||= {}; data.cali.week[k]=e.target.checked; save();
    });
  });
  $("#savePRs").onclick=()=>{
    data.cali.prs = {
      muscleup:Number($("#pr_mu").value||0),
      hspu:Number($("#pr_hspu").value||0),
      frontlever:$("#pr_fl").value||'',
      planche:$("#pr_pl").value||'',
      hs:$("#pr_hs").value||'',
      last: new Date().toISOString().slice(0,10)
    }; save(); $("#prSaved").textContent = "Guardado âœ”ï¸";
    setTimeout(()=>$("#prSaved").textContent=`Ãšltimo guardado: ${fmtDate(data.cali.prs.last)}`,800);
  };
  $("#caliNotes").value=data.cali.notes||"";
  $("#caliNotes").addEventListener("input", e=>{ data.cali.notes=e.target.value; save(); showSaved($("#saveCaliNotes")); });

  $("#formMicro").addEventListener("submit", e=>{
    e.preventDefault();
    const f=new FormData(e.target);
    const obj=f.get("objetivo"), dias=Number(f.get("dias")), nivel=f.get("nivel");
    const base=["Lunes","Martes","MiÃ©rcoles","Jueves","Viernes","SÃ¡bado","Domingo"];
    let plan=[];
    for(let i=0;i<dias;i++){
      let sesion="";
      if(obj==="fuerza"){
        sesion=i%2===0?"Push (HSPU, fondos, planche lean)":"Pull (dominadas, front lever rows, MU negativas)";
      }else if(obj==="skills"){
        sesion="Skills: TÃ©cnica MU, Front Lever (tuckâ†’adv), Planche (lean/tuck), Handstand";
      }else if(obj==="hipertrofia"){
        sesion=i%2===0?"Pecho/Hombro/TrÃ­ceps (8â€“12 rep)":"Espalda/BÃ­ceps/Core (8â€“12 rep)";
      }else{
        sesion=(i%3===0)?"Push (HSPU/dips)":"Pull/Core (dominadas, FL rows, hollow)";
      }
      plan.push({dia:base[i], sesion:sesion+" Â· "+nivel});
    }
    data.cali.micro=plan; save(); render();
  });

  $("#saveMicro").onclick=()=>{
    const rows=$$("#tblMicro tbody tr");
    data.cali.micro=rows.map(r=>({dia:r.children[0].textContent, sesion:r.children[1].textContent.trim()}));
    save(); alert("Microciclo guardado âœ”ï¸");
  };
}

function hookCalendario(){
  data.calendar ||= {cursor: new Date(new Date().getFullYear(), new Date().getMonth(), 1).toISOString()}; save();
  $("#prevMonth").onclick=()=>{ const c=new Date(data.calendar.cursor); c.setMonth(c.getMonth()-1); data.calendar.cursor=c.toISOString(); save(); render(); };
  $("#nextMonth").onclick=()=>{ const c=new Date(data.calendar.cursor); c.setMonth(c.getMonth()+1); data.calendar.cursor=c.toISOString(); save(); render(); };
  $("#todayBtn").onclick=()=>{ const t=new Date(); data.calendar.cursor=new Date(t.getFullYear(),t.getMonth(),1).toISOString(); save(); render(); };

  // Google API
  const gStatus=$("#gStatus"), gCals=$("#gCals");
  const updateStatus = (msg) => gStatus.textContent = msg || "";

  const gapiInit = async () => {
    try{
      await gapi.load("client");
      await gapi.client.init({
        apiKey: GOOGLE_API_KEY,
        discoveryDocs: [GOOGLE_DISCOVERY]
      });
      google.accounts.id.initialize({
        client_id: GOOGLE_CLIENT_ID,
        callback: (resp)=>{ /* handled by token client below */ }
      });
      window.tokenClient = google.accounts.oauth2.initTokenClient({
        client_id: GOOGLE_CLIENT_ID,
        scope: GOOGLE_SCOPES,
        prompt: '',
        callback: (tokenResp)=>{
          googleAuthed = !!tokenResp && !!tokenResp.access_token;
          updateStatus(googleAuthed? "Autenticado âœ”ï¸" : "No autenticado");
          if(googleAuthed){ loadCalendars(); loadMonthEvents(); }
        }
      });
      updateStatus("API lista. Pulsa Iniciar sesiÃ³n.");
    }catch(err){
      updateStatus("Error iniciando API. Revisa Client ID / API Key.");
      console.error(err);
    }
  };

  const signIn = ()=> {
    if(!window.tokenClient){ updateStatus("Primero pulsa Inicializar API"); return; }
    window.tokenClient.requestAccessToken({prompt: 'consent'});
  };
  const signOut = ()=> {
    google.accounts.oauth2.revoke(localStorage.getItem('g_access_token') || '', ()=>{});
    googleAuthed = false; updateStatus("SesiÃ³n cerrada");
    $("#gEventList").innerHTML = "";
    $$(".g-events").forEach(c=>c.innerHTML="");
  };

  const loadCalendars = async ()=>{
    try{
      const res = await gapi.client.calendar.calendarList.list();
      const items = res.result.items || [];
      gCals.innerHTML = items.map(c=>`<option value="${c.id}">${c.summary}</option>`).join('');
      gCals.onchange = ()=> loadMonthEvents();
    }catch(err){ console.error(err); updateStatus("No pude cargar tus calendarios."); }
  };

  const monthRange = ()=>{
    const cur=new Date(data.calendar.cursor);
    const start=new Date(cur.getFullYear(), cur.getMonth(), 1);
    const end=new Date(cur.getFullYear(), cur.getMonth()+1, 1);
    return {timeMin:start.toISOString(), timeMax:end.toISOString()};
  };

  const loadMonthEvents = async ()=>{
    try{
      const calId = gCals.value;
      if(!calId){ updateStatus("Selecciona un calendario."); return; }
      const {timeMin,timeMax} = monthRange();
      const res = await gapi.client.calendar.events.list({calendarId: calId, timeMin, timeMax, singleEvents:true, orderBy:'startTime'});
      const items = res.result.items || [];
      // pintar
      $$(".g-events").forEach(c=>c.innerHTML="");
      const list = items.map(ev=>{
        const start = ev.start.dateTime || ev.start.date;
        const day = (ev.start.date || (new Date(start)).toISOString().slice(0,10));
        const timeStr = ev.start.dateTime ? new Date(ev.start.dateTime).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}) : "";
        const cell = $(`.g-events[data-day="${day}"]`);
        if(cell){ cell.innerHTML += `<div class="cal-ev">${timeStr? timeStr+' Â· ' : ''}${ev.summary||'(Sin tÃ­tulo)'}</div>`; }
        return `<div class="item"><div>${day} ${timeStr}</div><div><strong>${ev.summary||'(Sin tÃ­tulo)'}</strong></div></div>`;
      }).join('') || '<div class="muted mini">Sin eventos este mes.</div>';
      $("#gEventList").innerHTML = list;
      updateStatus(`Cargados ${items.length} eventos.`);
    }catch(err){
      console.error(err);
      updateStatus("Error cargando eventos (Â¿permisos?).");
    }
  };

  $("#gInit").onclick = gapiInit;
  $("#gSignIn").onclick = signIn;
  $("#gSignOut").onclick = signOut;

  $("#gCreate").addEventListener("submit", async e=>{
    e.preventDefault();
    try{
      const calId = gCals.value;
      if(!calId){ updateStatus("Selecciona un calendario."); return; }
      const f=new FormData(e.target);
      const date=f.get("date"), time=f.get("time"), title=f.get("title").trim();
      let start, end;
      if(time){
        const [hh,mm]=time.split(":").map(Number);
        const d=new Date(date); d.setHours(hh,mm,0,0);
        start={dateTime:d.toISOString()};
        end={dateTime:new Date(d.getTime()+60*60*1000).toISOString()};
      }else{
        start={date:date}; end={date:date};
      }
      const body={summary:title, start, end};
      await gapi.client.calendar.events.insert({calendarId: calId, resource: body});
      updateStatus("Evento creado âœ”ï¸");
      loadMonthEvents();
    }catch(err){
      console.error(err);
      updateStatus("No pude crear el evento.");
    }
  });
}

function hookDiario(){
  data.diario ||= {entries:[]}; save();
  $("#formEntry").addEventListener("submit", e=>{
    e.preventDefault();
    const f=new FormData(e.target);
    const entry = {id:uid(), date:f.get("date"), title:(f.get("title")||"").trim(), text:(f.get("text")||"").trim()};
    data.diario.entries.push(entry); save(); render();
  });
  const list = $("#diaryList");
  list.addEventListener("click", e=>{
    const id = e.target.dataset.del || e.target.dataset.edit;
    if(!id) return;
    const idx = data.diario.entries.findIndex(x=>x.id===id);
    if(idx<0) return;
    if(e.target.dataset.del){
      if(confirm("Â¿Eliminar la entrada?")){ data.diario.entries.splice(idx,1); save(); render(); }
    }else{
      const cur = data.diario.entries[idx];
      const title = prompt("TÃ­tulo:", cur.title||"") ?? cur.title;
      const text = prompt("Contenido (lÃ­neas \\n):", cur.text||"") ?? cur.text;
      data.diario.entries[idx] = {...cur, title, text};
      save(); render();
    }
  });
  $("#searchDiary").addEventListener("keydown", e=>{
    if(e.key==="Enter"){
      const q=e.target.value.trim().toLowerCase();
      $$("#diaryList .entry").forEach(div=>{
        div.style.outline = div.textContent.toLowerCase().includes(q) && q ? "2px solid var(--accent)" : "none";
      });
    }
  });
}

/* ========= Exportar/Importar/Temas/Atajos ========= */
$("#exportBtn").onclick=()=>{
  const blob = new Blob([JSON.stringify(data,null,2)],{type:"application/json"});
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = "agenda_offline_backup.json";
  a.click();
  URL.revokeObjectURL(a.href);
};
$("#importFile").addEventListener("change", e=>{
  const file=e.target.files[0]; if(!file) return;
  const reader=new FileReader();
  reader.onload = ev=>{
    try{
      const json=JSON.parse(ev.target.result);
      data = json; save(); alert("Importado correctamente âœ”ï¸"); render();
    }catch(err){ alert("Archivo invÃ¡lido."); }
  };
  reader.readAsText(file);
});
$("#themeBtn").onclick=()=>{
  const root=document.body; const isDark=root.getAttribute("data-theme")==="dark";
  root.setAttribute("data-theme", isDark?"light":"dark");
  localStorage.setItem(KEY+"_theme", isDark?"light":"dark");
};
(function restoreTheme(){
  const t=localStorage.getItem(KEY+"_theme"); if(t) document.body.setAttribute("data-theme", t);
})();
document.addEventListener("keydown", e=>{
  if(e.key==="/"){ e.preventDefault(); const box=$("#searchBox"); if(box){ box.focus(); box.select(); } }
  if(e.key==="n"){ const r=(location.hash||"#").slice(1); if(r==="laboral") $("#formLaboral input[name='title']")?.focus(); if(r==="master") $("#formMaster input[name='title']")?.focus(); if(r==="ingles") $("#formCards input[name='front']")?.focus(); }
});

/* ========= Arranque ========= */
render();
</script>
</body>
</html>
